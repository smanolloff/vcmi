====================
it seems battleQuery is reused on battle replay, so maybe this change
    is no longer needed (previously in CGameHandler, now BattleProcessor)

+       if (lastBattleQuery->isRecurrent) {
+           nextBattleQuery = lastBattleQuery;
+       } else {
+           nextBattleQuery = std::make_shared<CBattleQuery>(this, gs->curB);
+           nextBattleQuery->isRecurrent = true;
+       }

Same here:

+++ b/server/CQuery.cpp
@@ -194,7 +194,7 @@ void Queries::popQuery(PlayerColor player, QueryPtr query)
    query->onRemoval(player);

    //Exposure on query below happens only if removal didn't trigger any new query
-   if(nextQuery && nextQuery == topQuery(player))
+   if(nextQuery && nextQuery == topQuery(player) && !nextQuery->isRecurrent)^M

