@startuml "vcmi-1.32-routing-server-lobby-c4"

!include <C4/C4_Container>

HIDE_STEREOTYPE()
LAYOUT_LEFT_RIGHT()
skinparam DefaultFontName monospaced

title "VCMI-1.3.2 packet server routing (lobby)"

<style>
note {
  MaximumWidth 500
}
</style>

!$nbsp = "<U+00A0>"

' black
!$c1 = "#000000"
' blue
!$c2 = "#0000FF"
' fuchsia
!$c3 = "#FF00FF"
' green
!$c4 = "#008000"
' lime
!$c5 = "#00FF00"
' red
!$c6 = "#FF0000"
' teal
!$c7 = "#008080"

!function $replace($txt, $search, $repl)
  !$replaced = ""
  !while %strpos($txt, $search) >= 0
    !$position = %strpos($txt, $search)
    !$replaced = $replaced + %substr($txt, 0, $position) + $repl
    !$txt = %substr($txt, $position + %strlen($search))
  !endwhile
  !return $replaced + $txt
!endfunction

' avoids super long note lines in the diagram
!function $str($txt)
  !return $replace($txt, "\n", %newline())
!endfunction


!function $cm($class, $method) return "<font size=8 color=CCC>"+$class+"</font>"+"\n"+$method
!function $fn($method, $args) return $method+"\n<font size=8 color=CCC>("+$args+")</font>"

!function $ctag()
  !if %not(%variable_exists("$c"))
    !%set_variable_value("$c", 0)
  !elseif (%get_variable_value("$c") >= 7)
    !%set_variable_value("$c", 0)
  !endif

  !%set_variable_value("$c", %get_variable_value("$c") + 1)

  !return "c"+%get_variable_value("$c")
!endfunction

!function $inc()
  !if %not(%variable_exists("$i"))
    !%set_variable_value("$i", 0)
  !endif

  !%set_variable_value("$i", %get_variable_value("$i") + 1)

  !return %get_variable_value("$i")
!endfunction

!function $call($args) return $inc() + $nbsp + "(" + $args + ")"

' misc calls are hidden
' uncomment to show them (the diagram is a mess)
!$HIDE_MISC_CALLS = "true"

AddRelTag("c1", $textColor=$c1, $lineColor=$c1)
AddRelTag("c2", $textColor=$c2, $lineColor=$c2)
AddRelTag("c3", $textColor=$c3, $lineColor=$c3)
AddRelTag("c4", $textColor=$c4, $lineColor=$c4)
AddRelTag("c5", $textColor=$c5, $lineColor=$c5)
AddRelTag("c6", $textColor=$c6, $lineColor=$c6)
AddRelTag("c7", $textColor=$c7, $lineColor=$c7)

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''' CLASSES
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Boundary(CVCMIServer, "CVCMIServer") {
  Container(CVCMIServer_threadHandleClient, "threadHandleClient")
  note top of CVCMIServer_threadHandleClient
    incoming data
    <<START HERE>>
  end note

  Container(CVCMIServer_handleReceivedPack, $fn("handleReceivedPack", "CPackForLobby"))

  note top of CVCMIServer_handleReceivedPack
Bad naming in the source here:

apply = applier->getApplier(...)

**applier** should've been applierBase or applierRegistry.
**apply** should've been applier
  end note

  !if ($HIDE_MISC_CALLS != "true")
  Container(CVCMIServer_misc, "***")
  !endif
}

Boundary(LobbyClientConnected, "LobbyClientConnected < CPackForLobby < CPack") {
  Container(LobbyClientConnected_visit, $fn("visit", "ICPackVisitor"))
  Container(LobbyClientConnected_visitBasic, $fn("visitBasic", "ICPackVisitor"))
  Container(LobbyClientConnected_visitTyped, $fn("visitTyped", "ICPackVisitor"))

  !if ($HIDE_MISC_CALLS != "true")
  Container(LobbyClientConnected_misc, "***")
  !endif
}

Boundary(CVCMIServerPackVisitor, "CVCMIServerPackVisitor < ICPackVisitor") {
  Container(CVCMIServerPackVisitor_visitForLobby, $fn("visitForLobby", "CPackForLobby"))
}

Boundary(ClientPermissionsCheckerNetPackVisitor, "ClientPermissionsCheckerNetPackVisitor < ICPackVisitor") {
  Container(ClientPermissionsCheckerNetPackVisitor_visitForLobby, $fn("visitForLobby", "CPackForLobby"))

  note top of ClientPermissionsCheckerNetPackVisitor_visitForLobby
    Checks if packet comes from the host client
    (irrelevant in lobby)
  end note

  Container(ClientPermissionsCheckerNetPackVisitor_visitLobbyClientConnected, $fn("visitLobbyClientConnected", "LobbyClientConnected"))

  note top of ClientPermissionsCheckerNetPackVisitor_visitLobbyClientConnected
    Checks if packet comes from a known client
    (irrelevant in lobby)
  end note

  !if ($HIDE_MISC_CALLS != "true")
  Container(ClientPermissionsCheckerNetPackVisitor_misc, "***")
  !endif
}

Boundary(ApplyOnServerNetPackVisitor, "ApplyOnServerNetPackVisitor < ICPackVisitor") {
  Container(ApplyOnServerNetPackVisitor_visitForLobby, "visitForLobby")

  note top of ApplyOnServerNetPackVisitor_visitForLobby
    noop
  end note

  Container(ApplyOnServerNetPackVisitor_visitLobbyClientConnected, $fn("visitLobbyClientConnected", "LobbyClientConnected"))

  note top of ApplyOnServerNetPackVisitor_visitLobbyClientConnected
    core processing logic
  end note

  !if ($HIDE_MISC_CALLS != "true")
  Container(ApplyOnServerNetPackVisitor_misc, "***")
  !endif
}

Boundary(CApplier, "CApplier") {
  Container(CApplier_getApplier, $fn("getApplier", "uint16"))

  note top of CApplier_getApplier
    $str("\
Fetches a //shared// applier from the global registry: \
`CApplyOnServer<LobbyClientConnected>`.\n \
The //shared// applier can not store any state (my assumption) and \
CPack::visit will not be called with it.\n\n\
Instead, the caller will call a specific method on the //shared// applier: \
applyOnGH, where a //disposable// applier will be beuilt \
and used for the core processing - CPack::visit will be called with it.")
  end note
}

Boundary(CApplyOnServer, "CApplyOnServer<LobbyClientConnected> < CBaseForServerApply") {
  Container(CApplyOnServer_applyOnServerBefore, $fn("applyOnServerBefore", "CVCMIServer,"+$nbsp+"void*"))

  note top of CApplyOnServer_applyOnServerBefore
     $str("The `void*` is then static-casted to its specific type according to \
the class specialization\n\
(`LobbyClientConnected` in this case)\n\
\n\
This is completely unnecessary - we can simply accept a `CPack*` \
arg and not cast anything...")
  end note
}

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''' CALLS
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Rel(CVCMIServer_threadHandleClient, LobbyClientConnected_visit, $call("CVCMIServerPackVisitor"), $tags="$ctag()")
Rel(LobbyClientConnected_visit, LobbyClientConnected_visitBasic, $call("CVCMIServerPackVisitor"), $tags="$ctag()")
Rel(LobbyClientConnected_visitBasic, CVCMIServerPackVisitor_visitForLobby, $call("LobbyClientConnected"), $tags="$ctag()")
Rel(CVCMIServerPackVisitor_visitForLobby, CVCMIServer_handleReceivedPack, $call("LobbyClientConnected"), $tags="$ctag()")
Rel(CVCMIServer_handleReceivedPack, CApplier_getApplier, $call("uint16"), $tags="$ctag()")
Rel(CVCMIServer_handleReceivedPack, CApplyOnServer_applyOnServerBefore, $call("CVCMIServer, any"), $tags="$ctag()")
Rel(CApplyOnServer_applyOnServerBefore, LobbyClientConnected_visit, $call("ClientPermissionsCheckerNetPackVisitor"), $tags="$ctag()")
Rel(LobbyClientConnected_visit, LobbyClientConnected_visitBasic, $call("ClientPermissionsCheckerNetPackVisitor"), $tags="$ctag()")
Rel(LobbyClientConnected_visitBasic, ClientPermissionsCheckerNetPackVisitor_visitForLobby, $call("LobbyClientConnected"), $tags="$ctag()")

!if ($HIDE_MISC_CALLS != "true")
Rel(ClientPermissionsCheckerNetPackVisitor_visitForLobby, LobbyClientConnected_misc, $inc(), $tags="$ctag()")
Rel(ClientPermissionsCheckerNetPackVisitor_visitForLobby, LobbyClientConnected_misc, $inc(), $tags="$ctag()")
Rel(ClientPermissionsCheckerNetPackVisitor_visitForLobby, CVCMIServer_misc, $inc(), $tags="$ctag()")
!endif

Rel(LobbyClientConnected_visit, LobbyClientConnected_visitTyped, $call("ClientPermissionsCheckerNetPackVisitor"), $tags="$ctag()")
Rel(LobbyClientConnected_visitTyped, ClientPermissionsCheckerNetPackVisitor_visitLobbyClientConnected, $call("LobbyClientConnected"), $tags="$ctag()")

!if ($HIDE_MISC_CALLS != "true")
Rel(ClientPermissionsCheckerNetPackVisitor_visitLobbyClientConnected, CVCMIServer_misc, $inc(), $tags="$ctag()")
Rel(ClientPermissionsCheckerNetPackVisitor_visitLobbyClientConnected, LobbyClientConnected_misc, $inc(), $tags="$ctag()")
Rel(CApplyOnServer_applyOnServerBefore, ClientPermissionsCheckerNetPackVisitor_misc, $inc(), $tags="$ctag()")
!endif

Rel(CApplyOnServer_applyOnServerBefore, LobbyClientConnected_visit, $call("ApplyOnServerNetPackVisitor"), $tags="$ctag()")
Rel(LobbyClientConnected_visit, LobbyClientConnected_visitBasic, $call("ApplyOnServerNetPackVisitor"), $tags="$ctag()")
Rel(LobbyClientConnected_visitBasic, ApplyOnServerNetPackVisitor_visitForLobby, $call("LobbyClientConnected"), $tags="$ctag()")
Rel(LobbyClientConnected_visit, LobbyClientConnected_visitTyped, $call("ApplyOnServerNetPackVisitor"), $tags="$ctag()")
Rel(LobbyClientConnected_visitTyped, ApplyOnServerNetPackVisitor_visitLobbyClientConnected, $call("LobbyClientConnected"), $tags="$ctag()")

!if ($HIDE_MISC_CALLS != "true")
Rel(ApplyOnServerNetPackVisitor_visitLobbyClientConnected, CVCMIServer_misc, $inc(), $tags="$ctag()")
Rel(ApplyOnServerNetPackVisitor_visitLobbyClientConnected, LobbyClientConnected_misc, $inc(), $tags="$ctag()")
Rel(CApplyOnServer_applyOnServerBefore, ApplyOnServerNetPackVisitor_misc, $inc(), $tags="$ctag()")
!endif

' Lay_Distance(CVCMIServer, CPack, 1)
' Lay_Distance(CPack, Visitor, 1)

skinparam legend {
  FontColor Black
  BackgroundColor White
  ' does not work for some reason
  BorderColor White
  BorderThickness 0
}

legend bottom left
  | Color sequence |
  | <$c1> |
  | <$c2> |
  | <$c3> |
  | <$c4> |
  | <$c5> |
  | <$c6> |
  | <$c7> |
endlegend

@enduml
