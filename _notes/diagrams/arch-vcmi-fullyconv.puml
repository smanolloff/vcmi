@startuml "arch-vcmi-fullyconv"
' left to right direction

skinparam defaultTextAlignment center
skinparam NoteTextAlignment left

<style>
Collections {
  BackGroundColor #efe
}


</style>

'''
''' Utility functions
'''

!function $replace($txt, $search, $repl)
  !$replaced = ""
  !while %strpos($txt, $search) >= 0
    !$position = %strpos($txt, $search)
    !$replaced = $replaced + %substr($txt, 0, $position) + $repl
    !$txt = %substr($txt, $position + %strlen($search))
  !endwhile
  !return $replaced + $txt
!endfunction

' Wraps each line of $txt within $open and $close
' Example:
'   $tagged_text("<color:red>", "two\nlines", "</color>")
'   => "<color:red>two</color>\n<color:red>lines</color>")"
!function $tagged_text($open, $txt, $close) return $open + $replace($txt, "\n", $close+"\n"+$open) + $close

!function $node_text($name) return $tagged_text("<b>", $name, "</b>")
!function $node_text($name, $desc) return $node_text($name)+"\n"+$tagged_text("<font:monospaced><size:10>", $desc, "</size></font>")
!function $node_text($name, $desc, $txt) return $node_text($name, $desc)+"\n\n"+$tagged_text("<color:888><size:10>", $txt, "</size></color>")

'''
''' Node types
'''

' Data
!procedure $Data($id, $name)
  Collections $id as "$node_text($name)"
!endprocedure

!procedure $Data($id, $name, $desc)
  Collections $id as "$node_text($name, $desc)"
!endprocedure

!procedure $Data($id, $name, $desc, $txt)
  Collections $id as "$node_text($name, $desc, $txt)"
!endprocedure

' MLP (FC)
!procedure $MLP($id, $name, $desc)
  Hexagon $id as "$node_text($name, $desc)"
!endprocedure
!procedure $MLP($id, $name, $desc, $txt)
  Hexagon $id as "$node_text($name, $desc, $txt)"
!endprocedure

' Transformer
!procedure $Transformer($id, $name, $desc)
  Queue $id as "$node_text($name, $desc)"
!endprocedure
!procedure $Transformer($id, $name, $desc, $txt)
  Queue $id as "$node_text($name, $desc, $txt)"
!endprocedure

' Convolution
!procedure $Convolution($id, $name, $desc)
  Node $id as "$node_text($name, $desc)"
!endprocedure
!procedure $Convolution($id, $name, $desc, $txt)
  Node $id as "$node_text($name, $desc, $txt)"
!endprocedure

' Output
!procedure $Output($id, $name)
  Component $id as "$node_text($name)" #orange
!endprocedure

!procedure $Output($id, $name, $desc)
  Component $id as "$node_text($name, $desc)" #orange
!endprocedure

' Condition
!procedure $Condition($id, $name)
  Boundary $id as "$node_text($name)"
!endprocedure

!procedure $Condition($id, $name, $desc)
  Boundary $id as "$node_text($name, $desc)"
!endprocedure

' Reshape
!procedure $Reshape($id)
  Control $id as " "
!endprocedure

' Activation
!procedure $Activation($id, $name)
  Action $id as "$name"
!endprocedure

' Sum / Mean / etc.
!procedure $Op($id, $name)
  Usecase $id as "$name"
!endprocedure
!procedure $Op($id, $name, $txt)
  ' Usecase $id as "$node_text($name, "", $txt)"
  Usecase $id as "$name\n$tagged_text("<color:888><size:10>", $txt, "</size></color>")"
!endprocedure

' Link
!procedure $Link($a, $b, $dim)
  $a --> $b : " $dim "
!endprocedure
!procedure $Link($a, $b, $dim, $txt)
  ' The newline causes a bug where the 1st line appears
  ' on the top-left side
  ' ...but it looks better that way
  $a --> $b : " $dim "\n$txt
!endprocedure

' title "wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww"
' left to right direction

$Data(obs, "Observation", "11x15*N", "N = N_HEX_ATTRS")
$MLP(encoder, "MLP", "E", "Each hex is\nembedded separately\n(embedding_size=E)")
$Link(obs, encoder, "(11, 15*N)\n→\n(165, N)")
$Convolution(conv1, "Conv2d", "kernel_size=5\nstride=1\nout_channels=32")
$Link(encoder, conv1, "<<ReLU>>\n\n(165, E)\n→\n(E, 11, 15)")
$Convolution(conv2, "Conv2d", "kernel_size=3\nstride=1\nout_channels=64 ")
$Link(conv1, conv2, "<<ReLU>>\n\n(32, 11, 15)")
$Data(hex_embeddings, "Hex\nEmbeddings")
$Link(conv2, hex_embeddings, "<<ReLU>>\n\n(64, 11, 15)")

Frame "Non-spatial" {
  $MLP(nonspatial_mlp, "MLP", "10560 → 256")
  $Link(hex_embeddings, nonspatial_mlp, "(64, 11, 15)\n→\n(10560,)")
  $Data(embedded_summary, "Summary\nEmbedding")
  $Link(nonspatial_mlp, embedded_summary, "<<ReLU>>\n\n(256,)")
  $MLP(action1_mlp, "MLP", "256 → 5")
  $Link(embedded_summary, action1_mlp, "")

  $Data(action1, "Action1", "apply mask & sample")
  $Link(action1_mlp, action1, "(5,)")

  $MLP(value_mlp, "MLP", "256 → 1")
  $Link(embedded_summary, value_mlp, "")
  $Data(value, "Value")
  $Link(value_mlp, value, "")
}

$Op(cond1, "Needs hex?")
$Link(action1, cond1, "")

$Output(action1_out, "Action1")
$Link(cond1, action1_out, "N")

note bottom of action1_out
* Defend
* Wait
end note

$Op(broadcast1, "broadcast")
$Link(cond1, broadcast1, "Y")
$Op(concat1, "concat\n(as channel)")
$Link(broadcast1, concat1, "(1, 11, 15)")
$Link(hex_embeddings, concat1, "(64, 11, 15)")
$Data(hex_embeddings2, "Hex\nEmbeddings #2", "i.e. combined with Action1")
$Link(concat1, hex_embeddings2, "(65, 11, 15)")

Frame "Spatial #1" {
  $Convolution(conv3, "Conv2d", "kernel_size=1\nstride=1\nout_channels=1")
  $Link(hex_embeddings2, conv3, "(65, 11, 15)")
  $Data(action2, "Action2", "apply mask & sample")
  $Link(conv3, action2, "(1, 11, 15)\n→\n(165,)")
}

$Op(cond2, "Needs hex?")
$Link(action2, cond2, "")
$Output(action2_out, "Action2", "i.e. Hex for Action1")
$Link(cond2, action2_out, "N")

note bottom of action2_out
* Move to Hex
* Shoot at Hex
end note

$Op(broadcast2, "broadcast")
$Link(cond2, broadcast2, "Y")
$Op(concat2, "concat\n(as channel)")
$Link(broadcast2, concat2, "(1, 11, 15)")
$Link(hex_embeddings2, concat2, "(65, 11, 15)")
$Data(hex_embeddings3, "Hex\nEmbeddings #3", "i.e. combined with Hex1")
$Link(concat2, hex_embeddings3, "(66, 11, 15)")

Frame "Spatial #2" {
  $Convolution(conv4, "Conv2d", "kernel_size=1\nstride=1\nout_channels=1")
  $Link(hex_embeddings3, conv4, "(66, 11, 15)")
  $Data(action3, "Action3", "apply mask & sample")
  $Link(conv4, action3, "(1, 11, 15)\n→\n(165,)")
}

$Output(action3_out, "Action3", "i.e. Hex2 for Action1")
$Link(action3, action3_out, "N")

note bottom of action3_out
* Move to Hex then attack at Hex2
end note

@enduml

